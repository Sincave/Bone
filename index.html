<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم المبيعات - Elhomssi Parfums</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- الهيدر الثابت -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <h1><i class="fas fa-chart-line"></i> لوحة تحكم المبيعات</h1>
                <p>Elhomssi Parfums</p>
            </div>
            <div class="manager-info">
                <div class="manager-img">
                    <!-- صورة المدير الدائرية -->
                    <img src="Logo22.jpg" alt="صورة المدير">
                </div>
                <p class="manager-name">المدير: مصطفى </p>
            </div>
        </div>
    </header>

    <main class="container main-container">
        <!-- القسم الأيسر: نموذج الإضافة والبون -->
        <div class="left-section">
            <!-- نموذج إضافة منتج -->
            <section class="card form-section">
                <h2><i class="fas fa-plus-circle"></i> إضافة عملية بيع جديدة</h2>
                <form id="salesForm">
                    <div class="form-group">
                        <label for="productName"><i class="fas fa-tag"></i> اسم العطر</label>
                        <input type="text" id="productName" placeholder="أدخل اسم العطر..." required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productPrice"><i class="fas fa-money-bill-wave"></i> الثمن (درهم)</label>
                            <input type="number" id="productPrice" min="1" placeholder="السعر" required>
                        </div>
                        <div class="form-group">
                            <label for="productQuantity"><i class="fas fa-boxes"></i> الكمية</label>
                            <input type="number" id="productQuantity" min="1" value="1" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="deliveryPrice"><i class="fas fa-shipping-fast"></i> ثمن التوصيل (درهم)</label>
                        <input type="number" id="deliveryPrice" min="0" value="30" required>
                    </div>
                    
                    <div class="form-total">
                        <p>المجموع: <span id="previewTotal">0</span> درهم</p>
                    </div>
                    
                    <button type="submit" class="btn-submit">
                        <i class="fas fa-cart-plus"></i> إضافة المنتج وعرض البون
                    </button>
                </form>
            </section>

            <!-- البون (الإيصال) -->
            <section class="card receipt-section" id="receiptSection" style="display: none;">
                <h2><i class="fas fa-receipt"></i> بون الشراء</h2>
                <div class="receipt" id="receipt">
                    <!-- سيتم ملؤه بالجافاسكريبت -->
                </div>
                <div class="receipt-actions">
                    <button id="printReceipt" class="btn-print">
                        <i class="fas fa-print"></i> طباعة البون
                    </button>
                    <button id="closeReceipt" class="btn-close">
                        <i class="fas fa-times"></i> إغلاق
                    </button>
                </div>
            </section>
        </div>

        <!-- القسم الأيمن: الإحصائيات والرسم البياني -->
        <div class="right-section">
            <!-- أكثر المنتجات مبيعاً -->
            <section class="card best-sellers">
                <h2><i class="fas fa-trophy"></i> أكثر العطور مبيعاً</h2>
                <div class="table-container">
                    <table id="bestSellersTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>اسم العطر</th>
                                <th>الكمية</th>
                                <th>الإجمالي</th>
                            </tr>
                        </thead>
                        <tbody id="bestSellersBody">
                            <!-- سيتم ملؤه بالجافاسكريبت -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- الرسم البياني والمبيعات الشهرية -->
            <section class="card chart-section">
                <h2><i class="fas fa-chart-bar"></i> المبيعات الشهرية</h2>
                <div class="chart-container">
                    <canvas id="salesChart"></canvas>
                </div>
                <div class="monthly-totals">
                    <h3><i class="fas fa-calendar-alt"></i> إجمالي المبيعات لكل شهر</h3>
                    <ul id="monthlyTotalsList">
                        <!-- سيتم ملؤه بالجافاسكريبت -->
                    </ul>
                </div>
            </section>
        </div>
    </main>

    <!-- نافذة ملخص الشهر -->
    <div id="monthModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-file-invoice-dollar"></i> ملخص الشهر</h2>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- سيتم ملؤه بالجافاسكريبت -->
            </div>
            <div class="modal-footer">
                <button id="printMonthSummary" class="btn-print">
                    <i class="fas fa-print"></i> طباعة الملخص
                </button>
            </div>
        </div>
    </div>



    <script src="script.js"></script>
</body>
</html>




<style>
    /* Reset وإعدادات أساسية */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}




:root {
    --primary-color: #2c3e50;
    --secondary-color: #3498db;
    --accent-color: #e74c3c;
    --light-color: #ecf0f1;
    --dark-color: #2c3e50;
    --success-color: #27ae60;
    --warning-color: #f39c12;
    --border-color: #ddd;
    --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    --transition: all 0.3s ease;
}

body {
    font-family: 'Cairo', sans-serif;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    color: #333;
    line-height: 1.6;
    min-height: 100vh;
    padding-top: 80px;
    direction: rtl;
}

.container {
    width: 100%;
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 20px;
}

/* الهيدر الثابت */
.header {
    background: black;
    color: white;
    padding: 15px 0;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    box-shadow: var(--shadow);
}

.header .container {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.logo h1 {
    font-size: 1.5rem;
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.logo p {
    font-size: 0.9rem;
    opacity: 0.9;
}

.manager-info {
    display: flex;
    align-items: center;
    gap: 15px;
}

.manager-img {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    overflow: hidden;
    border: 2px solid white;
    transition: var(--transition);
}

.manager-img:hover {
    transform: scale(1.05);
    border-color: var(--accent-color);
}

.manager-img img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.manager-name {
    font-weight: 600;
    font-size: 0.9rem;
}

/* التصميم الرئيسي */
.main-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    padding: 30px 20px;
}

.card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: var(--shadow);
    transition: var(--transition);
    border: 1px solid var(--border-color);
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.card h2 {
    color: black;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px dashed var(--border-color);
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.3rem;
}

/* نموذج الإضافة */
.form-section {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: black;
    display: flex;
    align-items: center;
    gap: 8px;
}

.form-group input {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid var(--border-color);
    border-radius: 10px;
    font-size: 1rem;
    transition: var(--transition);
    font-family: 'Cairo', sans-serif;
}

.form-group input:focus {
    outline: none;
    border-color: var(--secondary-color);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.form-total {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 10px;
    margin: 20px 0;
    text-align: center;
    border: 2px dashed var(--border-color);
}

.form-total p {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--success-color);
}

.btn-submit {
    width: 100%;
    padding: 15px;
    background: black;
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    font-family: 'Cairo', sans-serif;
}

.btn-submit:hover {
    background: linear-gradient(135deg, #2980b9 0%, var(--secondary-color) 100%);
    transform: translateY(-2px);
}

/* البون (الإيصال) */
.receipt {
    background: white;
  
    border-radius: 10px;
    padding: 25px;
    font-family: 'Courier New', monospace;
    position: relative;
    overflow: hidden;
}

.receipt::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 5px;
    background: black;
}

.receipt-header {
    text-align: center;
    margin-bottom: 25px;
    padding-bottom: 15px;
    
}


.receipt-logo-img {
    width: 60px;        /* حجم الدائرة */
    height: 60px;
    border-radius: 50%;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
}

.receipt-logo-img img {
    width: 100%;
    height: 100%;
    object-fit: cover; /* باش الصورة تعمّر الدائرة مزيان */
}

.receipt-logo {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    margin-bottom: 15px;
}

.receipt-logo-img {
    width: 70px;
    height: 70px;
    background: linear-gradient(135deg, #d4af37, #ffd700);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    color: white;
    font-weight: bold;
}

.receipt-logo-text {
    font-size: 1.8rem;
    color: var(--primary-color);
    font-weight: bold;
}

.receipt-details {
    margin: 20px 0;
}

.receipt-item {
    display: flex;
    justify-content: space-between;
    padding: 12px 0;
    
    position: relative;
}

.receipt-item:last-child {
    border-bottom: 2px solid #000;
}

.receipt-item.total {
    font-size: 1.2rem;
    font-weight: bold;
    color: black;
}

.receipt-footer {
    text-align: center;
    margin-top: 25px;
    padding-top: 15px;
    border-top: 2px dashed #ccc;
    color: #666;
    font-size: 0.9rem;
}

.receipt-thankyou {
    margin-top: 20px;
    padding: 15px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 8px;
    text-align: center;
    font-style: italic;
    color: var(--primary-color);
    font-weight: 600;
}

.receipt-actions {
    display: flex;
    gap: 15px;
    margin-top: 20px;
}

.btn-print, .btn-close {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    font-family: 'Cairo', sans-serif;
}

.btn-print {
    background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
    color: white;
}

.btn-close {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: white;
}

.btn-print:hover, .btn-close:hover {
    transform: translateY(-2px);
    opacity: 0.9;
}

/* جدول أكثر المنتجات مبيعاً */
.table-container {
    overflow-x: auto;
}

#bestSellersTable {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

#bestSellersTable thead {
    background: black;
    color: white;
}

#bestSellersTable th {
    padding: 15px;
    text-align: center;
    font-weight: 600;
}

#bestSellersTable td {
    padding: 15px;
    text-align: center;
    border-bottom: 1px solid var(--border-color);
}

#bestSellersTable tbody tr:hover {
    background-color: #f8f9fa;
    transform: scale(1.01);
    transition: var(--transition);
}

#bestSellersTable tbody tr:nth-child(1) {
    background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
    font-weight: bold;
}

/* الرسم البياني */
.chart-container {
    position: relative;
    height: 300px;
    margin: 20px 0;
}

.monthly-totals {
    margin-top: 25px;
}

.monthly-totals h3 {
    color: var(--primary-color);
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.1rem;
}

#monthlyTotalsList {
    list-style: none;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
}

#monthlyTotalsList li {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 10px;
    border-left: 4px solid black;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

#monthlyTotalsList li:hover {
    background: #e3f2fd;
    transform: translateX(-5px);
}

#monthlyTotalsList li .month-total {
    font-weight: bold;
    color: var(--success-color);
}

/* النافذة المنبثقة */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 2000;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-content {
    background: white;
    margin: 5% auto;
    width: 90%;
    max-width: 700px;
    border-radius: 15px;
    overflow: hidden;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.modal-header {
    background: black;
    color: white;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.close-modal {
    font-size: 2rem;
    cursor: pointer;
    transition: var(--transition);
}

.close-modal:hover {
    color: var(--accent-color);
}

.modal-body {
    padding: 30px;
    max-height: 60vh;
    overflow-y: auto;
}

.modal-footer {
    padding: 20px;
    background: #f8f9fa;
    text-align: center;
    border-top: 1px solid var(--border-color);
}

/* تصميم متجاوب */
@media (max-width: 1200px) {
    .main-container {
        grid-template-columns: 1fr;
    }
    
    .left-section, .right-section {
        width: 100%;
    }
}

@media (max-width: 768px) {
    body {
        padding-top: 120px;
    }
    
    .header .container {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }
    
    .manager-info {
        flex-direction: column;
        text-align: center;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .receipt-actions {
        flex-direction: column;
    }
    
    .chart-container {
        height: 250px;
    }
    
    #monthlyTotalsList {
        grid-template-columns: 1fr;
    }
    
    .modal-content {
        margin: 10% auto;
        width: 95%;
    }
}

@media (max-width: 480px) {
    .card {
        padding: 15px;
    }
    
    .receipt {
        padding: 15px;
    }
    
    .receipt-logo {
        flex-direction: column;
    }
    
    #bestSellersTable th,
    #bestSellersTable td {
        padding: 10px 5px;
        font-size: 0.9rem;
    }
}

@media print {
    body * {
        visibility: hidden;
    }
    
    .receipt, .modal-content,
    .receipt *, .modal-content * {
        visibility: visible;
    }
    
    .receipt, .modal-content {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        box-shadow: none;
        border: none;
    }
    
    .receipt-actions,
    .modal-footer,
    .modal-header .close-modal {
        display: none !important;
    }
}
</style>


<script>

// متغيرات عامة
let sales = JSON.parse(localStorage.getItem('sales')) || [];
let chart = null;
const months = [
    'يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو',
    'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'
];

// تهيئة التطبيق عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    initApp();
    
    // تحديث المجموع عند تغيير القيم
    document.getElementById('productPrice').addEventListener('input', updateTotal);
    document.getElementById('productQuantity').addEventListener('input', updateTotal);
    document.getElementById('deliveryPrice').addEventListener('input', updateTotal);
    
    // إرسال النموذج
    document.getElementById('salesForm').addEventListener('submit', addSale);
    
    // أحداث الأزرار
    document.getElementById('printReceipt').addEventListener('click', printReceipt);
    document.getElementById('closeReceipt').addEventListener('click', closeReceipt);
    document.querySelector('.close-modal').addEventListener('click', closeModal);
    document.getElementById('printMonthSummary').addEventListener('click', printMonthSummary);
    
    // إغلاق النافذة المنبثقة عند النقر خارجها
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('monthModal');
        if (event.target === modal) {
            closeModal();
        }
    });
    
    // تحديث أولي للمجموع
    updateTotal();
});

// تهيئة التطبيق
function initApp() {
    renderBestSellers();
    renderMonthlyTotals();
    initChart();
}

// تحديث المجموع المسبق
function updateTotal() {
    const price = parseFloat(document.getElementById('productPrice').value) || 0;
    const quantity = parseInt(document.getElementById('productQuantity').value) || 0;
    const delivery = parseFloat(document.getElementById('deliveryPrice').value) || 0;
    const total = (price * quantity) + delivery;
    
    document.getElementById('previewTotal').textContent = total.toFixed(2);
}

// إضافة عملية بيع جديدة
function addSale(e) {
    e.preventDefault();
    
    const productName = document.getElementById('productName').value.trim();
    const price = parseFloat(document.getElementById('productPrice').value);
    const quantity = parseInt(document.getElementById('productQuantity').value);
    const delivery = parseFloat(document.getElementById('deliveryPrice').value);
    
    if (!productName || price <= 0 || quantity <= 0) {
        alert('يرجى ملء جميع الحقول بشكل صحيح');
        return;
    }
    
    const sale = {
        id: Date.now(),
        productName: productName,
        price: price,
        quantity: quantity,
        delivery: delivery,
        total: (price * quantity) + delivery,
        date: new Date().toISOString().split('T')[0],
        timestamp: Date.now()
    };
    
    sales.push(sale);
    localStorage.setItem('sales', JSON.stringify(sales));
    
    // عرض البون
    showReceipt(sale);
    
    // تحديث البيانات
    renderBestSellers();
    renderMonthlyTotals();
    updateChart();
    
    // إعادة تعيين النموذج
    document.getElementById('salesForm').reset();
    document.getElementById('deliveryPrice').value = 30;
    updateTotal();
}

// عرض البون
function showReceipt(sale) {
    const receiptHTML = `
        <div class="receipt-header">
            <div class="receipt-logo">
                <div class="receipt-logo-img">EP</div>
                <div class="receipt-logo-text">Elhomssi Parfums</div>
            </div>
            <p>فاتورة رقم: ${sale.id}</p>
            <p>التاريخ: ${formatDate(sale.date)}</p>
            <div style="border-bottom: 2px dashed #ccc; margin: 15px 0;"></div>
        </div>
        
        <div class="receipt-details">
            <div class="receipt-item">
                <span>اسم العطر:</span>
                <span>${sale.productName}</span>
            </div>
            <div class="receipt-item">
                <span>ثمن الوحدة:</span>
                <span>${sale.price.toFixed(2)} درهم</span>
            </div>
            <div class="receipt-item">
                <span>الكمية:</span>
                <span>${sale.quantity}</span>
            </div>
            <div class="receipt-item">
                <span>ثمن التوصيل:</span>
                <span>${sale.delivery.toFixed(2)} درهم</span>
            </div>
            <div class="receipt-item total">
                <span>المجموع النهائي:</span>
                <span>${sale.total.toFixed(2)} درهم</span>
            </div>
        </div>
        
        <div style="border-bottom: 2px dashed #ccc; margin: 20px 0;"></div>
        
        <div class="receipt-footer">
            <p><strong>التوصيل أقل من 24 ساعة، ستحصل على طلبك قريباً</strong></p>
            <p style="margin-top: 10px; color: #666; font-size: 0.85rem;">
                شكراً لزيارتكم، نتمنى لكم تجربة رائعة مع عطورنا
            </p>
        </div>
        
        <div class="receipt-thankyou">
            <p>شكرا لثقتكم في Elhomssi Parfums</p>
            <p style="font-size: 0.8rem; margin-top: 5px;">للاستفسار: 0612345678</p>
        </div>
    `;
    
    document.getElementById('receipt').innerHTML = receiptHTML;
    document.getElementById('receiptSection').style.display = 'block';
    
    // تمرير للبون
    document.getElementById('receiptSection').scrollIntoView({ behavior: 'smooth' });
}

// طباعة البون (معدلة)
function printReceipt() {
    const receiptContent = document.getElementById('receipt').innerHTML;
    const printWindow = window.open('', '_blank');
    
    // تحميل المحتوى بشكل كامل قبل الطباعة
    printWindow.document.write(`
        <html dir="rtl">
        <head>
            <title>طباعة البون - Elhomssi Parfums</title>
            <meta charset="UTF-8">
            <style>
                @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap');
                
                body { 
                    font-family: 'Cairo', sans-serif; 
                    padding: 20px; 
                    margin: 0;
                    background: white;
                    color: black;
                    line-height: 1.6;
                }
                .receipt-print { 
                    border: 2px solid #000; 
                    padding: 25px; 
                    max-width: 500px; 
                    margin: 0 auto;
                    border-radius: 10px;
                    box-shadow: 0 0 20px rgba(0,0,0,0.1);
                }
                .receipt-item { 
                    display: flex; 
                    justify-content: space-between; 
                    margin: 12px 0; 
                    padding-bottom: 8px; 
                    border-bottom: 1px dotted #333; 
                }
                .total { 
                    font-weight: bold; 
                    font-size: 1.3em; 
                    margin-top: 25px; 
                    padding-top: 15px;
                    border-top: 2px solid #333;
                }
                .receipt-header {
                    text-align: center;
                    margin-bottom: 25px;
                    border-bottom: 2px dashed #333;
                    padding-bottom: 20px;
                }
                .receipt-logo {
                    margin-bottom: 20px;
                }
                .receipt-logo-img {
                    width: 60px;
                    height: 60px;
                    background: linear-gradient(45deg, #2c3e50, #3498db);
                    color: white;
                    font-size: 24px;
                    font-weight: bold;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    border-radius: 50%;
                    margin: 0 auto 10px;
                }
                .receipt-logo-text {
                    font-size: 1.4em;
                    font-weight: bold;
                    color: #2c3e50;
                }
                .receipt-footer {
                    text-align: center;
                    margin-top: 35px;
                    padding-top: 20px;
                    border-top: 2px dashed #333;
                    font-size: 0.95em;
                }
                .receipt-thankyou {
                    text-align: center;
                    margin-top: 30px;
                    color: #2c3e50;
                    font-weight: bold;
                    padding: 15px;
                    background: #f8f9fa;
                    border-radius: 8px;
                }
                @media print { 
                    body { 
                        margin: 0; 
                        padding: 10px; 
                    }
                    .receipt-print {
                        border: none;
                        box-shadow: none;
                    }
                }
            </style>
        </head>
        <body onload="window.print(); setTimeout(() => window.close(), 500);">
            <div class="receipt-print">
                ${receiptContent}
            </div>
            
            <script>
                // منع ظهور صفحة about:blank
                window.onbeforeunload = null;
                
                // إعادة المحاولة إذا فشلت الطباعة
                function retryPrint() {
                    setTimeout(() => {
                        if (!document.hidden) {
                            window.print();
                        }
                    }, 1000);
                }
                
                // التحقق من نجاح الطباعة
                window.onafterprint = function() {
                    setTimeout(() => {
                        window.close();
                    }, 500);
                };
                
                // محاولة إعادة الطباعة إذا لم تنجح
                setTimeout(() => {
                    if (!document.hidden) {
                        retryPrint();
                    }
                }, 2000);
            <\/script>
        </body>
        </html>
    `);
    
    printWindow.document.close();
    
    // إضافة معالج للأخطاء
    printWindow.onerror = function() {
        console.log("Error loading print window");
    };
}

// إغلاق البون
function closeReceipt() {
    document.getElementById('receiptSection').style.display = 'none';
}

// عرض أكثر المنتجات مبيعاً
function renderBestSellers() {
    const products = {};
    
    sales.forEach(sale => {
        if (!products[sale.productName]) {
            products[sale.productName] = {
                quantity: 0,
                total: 0,
                delivery: 0
            };
        }
        products[sale.productName].quantity += sale.quantity;
        products[sale.productName].total += sale.total;
        products[sale.productName].delivery += sale.delivery;
    });
    
    const sortedProducts = Object.entries(products)
        .sort((a, b) => b[1].quantity - a[1].quantity)
        .slice(0, 10);
    
    const tbody = document.getElementById('bestSellersBody');
    tbody.innerHTML = '';
    
    sortedProducts.forEach(([productName, data], index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${index + 1}</td>
            <td>${productName}</td>
            <td>${data.quantity}</td>
            <td>${(data.total - data.delivery).toFixed(2)} درهم</td>
            <td>${data.delivery.toFixed(2)} درهم</td>
            <td>${data.total.toFixed(2)} درهم</td>
        `;
        tbody.appendChild(row);
    });
}

// عرض إجمالي المبيعات الشهرية - معدل لإظهار الأشهر الفعلية فقط
function renderMonthlyTotals() {
    const monthlyData = getMonthlyData();
    const list = document.getElementById('monthlyTotalsList');
    list.innerHTML = '';
    
    monthlyData.forEach((data, index) => {
        // عرض الشهر فقط إذا كان لديه مبيعات
        if (data.total > 0) {
            const li = document.createElement('li');
            li.dataset.month = index;
            li.innerHTML = `
                <span>${months[index]}</span>
                <span class="month-total">${data.total.toFixed(2)} درهم</span>
            `;
            
            li.addEventListener('click', () => showMonthSummary(index));
            list.appendChild(li);
        }
    });
    
    // إذا لم تكن هناك مبيعات، عرض رسالة
    if (list.children.length === 0) {
        const message = document.createElement('li');
        message.innerHTML = '<span style="text-align: center; color: #666; width: 100%;">لا توجد مبيعات مسجلة بعد</span>';
        list.appendChild(message);
    }
}

// الحصول على بيانات المبيعات الشهرية
function getMonthlyData() {
    const currentYear = new Date().getFullYear();
    const monthlyData = Array(12).fill().map(() => ({ 
        total: 0, 
        delivery: 0,
        products: {} 
    }));
    
    sales.forEach(sale => {
        const saleDate = new Date(sale.timestamp || sale.date);
        if (saleDate.getFullYear() === currentYear) {
            const month = saleDate.getMonth();
            monthlyData[month].total += sale.total;
            monthlyData[month].delivery += sale.delivery;
            
            // تتبع المنتجات لكل شهر
            if (!monthlyData[month].products[sale.productName]) {
                monthlyData[month].products[sale.productName] = {
                    quantity: 0,
                    delivery: 0
                };
            }
            monthlyData[month].products[sale.productName].quantity += sale.quantity;
            monthlyData[month].products[sale.productName].delivery += sale.delivery;
        }
    });
    
    return monthlyData;
}

// تهيئة الرسم البياني (معدل مع عمود التوصيل)
function initChart() {
    const ctx = document.getElementById('salesChart').getContext('2d');
    const monthlyData = getMonthlyData();
    
    // إنشاء ألوان متدرجة
    const colors = generateGradientColors(12);
    
    chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: months,
            datasets: [
                {
                    label: 'قيمة المنتجات',
                    data: monthlyData.map(data => data.total - data.delivery),
                    backgroundColor: colors.map(color => color.fill),
                    borderColor: colors.map(color => color.border),
                    borderWidth: 2,
                    borderRadius: 6,
                    hoverBackgroundColor: colors.map(color => color.hover)
                },
                {
                    label: 'مبلغ التوصيل',
                    data: monthlyData.map(data => data.delivery),
                    backgroundColor: 'rgba(52, 152, 219, 0.7)',
                    borderColor: 'rgb(41, 128, 185)',
                    borderWidth: 2,
                    borderRadius: 6,
                    hoverBackgroundColor: 'rgba(52, 152, 219, 0.9)'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        font: {
                            family: "'Cairo', sans-serif",
                            size: 14
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += context.parsed.y.toFixed(2) + ' درهم';
                            
                            // إضافة المجموع الكلي في التلميح
                            if (context.datasetIndex === 0) {
                                const deliveryValue = chart.data.datasets[1].data[context.dataIndex];
                                const total = context.parsed.y + deliveryValue;
                                label += ` (المجموع: ${total.toFixed(2)} درهم)`;
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + ' درهم';
                        },
                        font: {
                            family: "'Cairo', sans-serif"
                        }
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                },
                x: {
                    ticks: {
                        font: {
                            family: "'Cairo', sans-serif"
                        }
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                }
            },
            onClick: (e, elements) => {
                if (elements.length > 0) {
                    const monthIndex = elements[0].index;
                    showMonthSummary(monthIndex);
                }
            }
        }
    });
}

// تحديث الرسم البياني
function updateChart() {
    if (chart) {
        const monthlyData = getMonthlyData();
        chart.data.datasets[0].data = monthlyData.map(data => data.total - data.delivery);
        chart.data.datasets[1].data = monthlyData.map(data => data.delivery);
        chart.update();
    }
}

// إنشاء ألوان متدرجة للرسم البياني
function generateGradientColors(count) {
    const colors = [];
    for (let i = 0; i < count; i++) {
        const hue = (i * 30) % 360;
        colors.push({
            fill: `hsla(${hue}, 70%, 60%, 0.7)`,
            border: `hsl(${hue}, 70%, 40%)`,
            hover: `hsla(${hue}, 80%, 70%, 0.9)`
        });
    }
    return colors;
}

// عرض ملخص الشهر
function showMonthSummary(monthIndex) {
    const monthlyData = getMonthlyData();
    const monthData = monthlyData[monthIndex];
    
    // العثور على المنتج الأكثر مبيعاً لهذا الشهر
    let bestProduct = '';
    let bestQuantity = 0;
    let bestDelivery = 0;
    
    if (monthData.products && Object.keys(monthData.products).length > 0) {
        const productsArray = Object.entries(monthData.products);
        productsArray.sort((a, b) => b[1].quantity - a[1].quantity);
        bestProduct = productsArray[0][0];
        bestQuantity = productsArray[0][1].quantity;
        bestDelivery = productsArray[0][1].delivery;
    }
    
    const summaryHTML = `
        <div style="text-align: center; margin-bottom: 25px;">
            <h3 style="color: var(--primary-color); margin-bottom: 10px;">
                <i class="fas fa-calendar-check"></i> ${months[monthIndex]}
            </h3>
            <p style="color: #666;">ملخص المبيعات للشهر</p>
            <div style="border-bottom: 2px dashed #ccc; margin: 20px 0;"></div>
        </div>
        
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <span style="font-weight: bold; color: var(--primary-color);">
                    <i class="fas fa-chart-line"></i> إجمالي المبيعات:
                </span>
                <span style="font-size: 1.4rem; font-weight: bold; color: var(--success-color);">
                    ${monthData.total.toFixed(2)} درهم
                </span>
            </div>
            
            <div style="border-bottom: 1px dotted #ccc; margin: 15px 0;"></div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span style="font-weight: bold; color: #3498db;">
                    <i class="fas fa-truck"></i> إجمالي التوصيل:
                </span>
                <span style="font-weight: bold; color: #2980b9;">
                    ${monthData.delivery.toFixed(2)} درهم
                </span>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <span style="font-weight: bold; color: var(--primary-color);">
                    <i class="fas fa-box"></i> قيمة المنتجات:
                </span>
                <span style="font-weight: bold; color: var(--accent-color);">
                    ${(monthData.total - monthData.delivery).toFixed(2)} درهم
                </span>
            </div>
            
            <div style="border-bottom: 1px dotted #ccc; margin: 15px 0;"></div>
            
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: bold; color: var(--primary-color);">
                    <i class="fas fa-crown"></i> أكثر المنتجات مبيعاً:
                </span>
                <span style="font-weight: bold; color: var(--accent-color);">
                    ${bestProduct || 'لا توجد مبيعات'}
                </span>
            </div>
            
            ${bestProduct ? `
                <div style="text-align: center; margin-top: 10px; color: #666;">
                    تم بيع ${bestQuantity} وحدة | التوصيل: ${bestDelivery.toFixed(2)} درهم
                </div>
            ` : ''}
        </div>
        
        <div style="border-bottom: 2px dashed #ccc; margin: 25px 0;"></div>
        
        <div style="background: #fff8e1; padding: 15px; border-radius: 8px; border-right: 4px solid #ffc107;">
            <h4 style="color: var(--primary-color); margin-bottom: 10px;">
                <i class="fas fa-chart-pie"></i> تفاصيل المنتجات المبيعة
            </h4>
            
            ${monthData.products && Object.keys(monthData.products).length > 0 ? `
                <div style="max-height: 200px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--primary-color); color: white;">
                                <th style="padding: 10px; text-align: right;">المنتج</th>
                                <th style="padding: 10px; text-align: center;">الكمية</th>
                                <th style="padding: 10px; text-align: center;">التوصيل</th>
                                <th style="padding: 10px; text-align: center;">المجموع</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(monthData.products)
                                .sort((a, b) => b[1].quantity - a[1].quantity)
                                .map(([product, data]) => `
                                    <tr style="border-bottom: 1px solid #eee;">
                                        <td style="padding: 10px; text-align: right;">${product}</td>
                                        <td style="padding: 10px; text-align: center; font-weight: bold;">${data.quantity}</td>
                                        <td style="padding: 10px; text-align: center; color: #3498db;">${data.delivery.toFixed(2)} د</td>
                                        <td style="padding: 10px; text-align: center; font-weight: bold; color: var(--success-color);">
                                            ${((data.quantity * 100) + data.delivery).toFixed(2)} د
                                        </td>
                                    </tr>
                                `).join('')}
                        </tbody>
                    </table>
                </div>
            ` : '<p style="text-align: center; color: #666; padding: 20px;">لا توجد مبيعات لهذا الشهر</p>'}
        </div>
        
        <div style="margin-top: 25px; text-align: center; color: #666; font-size: 0.9rem;">
            <p><i class="fas fa-info-circle"></i> إحصائيات شهر ${months[monthIndex]} - ${new Date().getFullYear()}</p>
        </div>
    `;
    
    document.getElementById('modalBody').innerHTML = summaryHTML;
    document.getElementById('monthModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

// طباعة ملخص الشهر (معدلة)
function printMonthSummary() {
    const modalContent = document.getElementById('modalBody').innerHTML;
    const printWindow = window.open('', '_blank');
    
    printWindow.document.write(`
        <html dir="rtl">
        <head>
            <title>طباعة ملخص الشهر - Elhomssi Parfums</title>
            <meta charset="UTF-8">
            <style>
                @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap');
                
                body { 
                    font-family: 'Cairo', sans-serif; 
                    padding: 30px; 
                    max-width: 800px; 
                    margin: 0 auto; 
                    background: white;
                    color: black;
                }
                .print-header { 
                    text-align: center; 
                    margin-bottom: 30px; 
                    border-bottom: 3px double #000; 
                    padding-bottom: 20px; 
                }
                .print-header h1 {
                    color: #2c3e50;
                    margin-bottom: 10px;
                }
                .summary-item { 
                    display: flex; 
                    justify-content: space-between; 
                    margin: 15px 0; 
                    padding: 10px; 
                    border-bottom: 1px dotted #000; 
                }
                .total-amount { 
                    font-size: 1.4em; 
                    font-weight: bold; 
                    color: #27ae60; 
                    margin: 20px 0; 
                    text-align: center; 
                }
                table { 
                    width: 100%; 
                    border-collapse: collapse; 
                    margin: 20px 0; 
                    border: 1px solid #ddd;
                }
                th { 
                    background: #2c3e50; 
                    color: white; 
                    padding: 12px; 
                    text-align: right; 
                    border: 1px solid #444;
                }
                td { 
                    padding: 10px; 
                    border-bottom: 1px solid #ddd; 
                    text-align: right; 
                    border: 1px solid #ddd;
                }
                @media print { 
                    body { 
                        margin: 0; 
                        padding: 15px; 
                    } 
                    .no-print { 
                        display: none !important; 
                    }
                    table {
                        page-break-inside: avoid;
                    }
                }
                
                .delivery-amount {
                    color: #3498db;
                    font-weight: bold;
                }
                
                .product-amount {
                    color: #e74c3c;
                    font-weight: bold;
                }
            </style>
        </head>
        <body onload="window.print(); setTimeout(() => window.close(), 500);">
            <div class="print-header">
                <h1>ملخص المبيعات الشهري</h1>
                <h3>Elhomssi Parfums</h3>
                <p>التاريخ: ${formatDate(new Date().toISOString().split('T')[0])}</p>
            </div>
            
            ${modalContent}
            
            <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 2px solid #000;">
                <p style="font-size: 1.1em; font-weight: bold;">شكراً لثقتكم في Elhomssi Parfums</p>
                <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                    هذا المستند تم إنشاؤه تلقائياً من نظام المبيعات
                </p>
            </div>
            
            <script>
                // منع ظهور صفحة about:blank
                window.onbeforeunload = null;
                
                // التحقق من نجاح الطباعة
                window.onafterprint = function() {
                    setTimeout(() => {
                        window.close();
                    }, 500);
                };
                
                // محاولة إعادة الطباعة إذا لم تنجح
                setTimeout(() => {
                    if (!document.hidden) {
                        window.print();
                    }
                }, 2000);
            <\/script>
        </body>
        </html>
    `);
    
    printWindow.document.close();
    
    // إضافة معالج للأخطاء
    printWindow.onerror = function() {
        console.log("Error loading print window");
    };
}

// إغلاق النافذة المنبثقة
function closeModal() {
    document.getElementById('monthModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

// تنسيق التاريخ
function formatDate(dateString) {
    const date = new Date(dateString);
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
}

// دالة لتنظيف البيانات القديمة (اختيارية)
function cleanupOldData() {
    const oneYearAgo = Date.now() - (365 * 24 * 60 * 60 * 1000);
    sales = sales.filter(sale => sale.timestamp > oneYearAgo);
    localStorage.setItem('sales', JSON.stringify(sales));
    updateChart();
}

// تشغيل التنظيف كل 30 يوم
setInterval(cleanupOldData, 30 * 24 * 60 * 60 * 1000);
               
</script>
