<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم مبيعات ELHOMSSI Parfums</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <h1><i class="fas fa-chart-line"></i> ELHOMSSI Parfums</h1>
            <p>نظام إدارة المبيعات</p>
        </div>
        <div class="header-right">
            <div class="notification-icon" id="notificationIcon">
                <i class="fas fa-bell"></i>
                <span class="badge" id="notificationBadge">3</span>
            </div>
        </div>
    </header>

    <!-- Notification Panel -->
    <div class="notification-panel" id="notificationPanel">
        <div class="notification-header">
            <h3><i class="fas fa-bell"></i> الإشعارات</h3>
            <button class="close-btn" id="closeNotifications">×</button>
        </div>
        <div class="notification-content">
            <div class="notification-item">
                <div class="notification-text">
                    <strong>ملخص المبيعات القادم</strong>
                    <p>سيتم عرض ملخص المبيعات خلال:</p>
                    <div class="countdown" id="countdown">
                        <span id="hours">02</span>:<span id="minutes">30</span>:<span id="seconds">45</span>
                    </div>
                </div>
                <button class="delete-notification" onclick="deleteNotification(this)">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Welcome Message -->
    <div class="welcome-message" id="welcomeMessage">
        <div class="welcome-content">
            <h3><i class="fas fa-gift"></i> أهلاً بك في نظام إدارة مبيعات ELHOMSSI Parfums!</h3>
            <p>يمكنك إضافة مبيعات جديدة، متابعة التقارير، وعرض الإحصائيات.</p>
            <button class="close-welcome" onclick="closeWelcome()">×</button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container">
        <div class="row">
            <!-- Left Column: Form and Receipt -->
            <div class="col-lg-6">
                <!-- Sales Form -->
                <div class="card">
                    <h2><i class="fas fa-plus-circle"></i> إضافة عملية بيع</h2>
                    <form id="saleForm">
                        <div class="form-group">
                            <label for="productName"><i class="fas fa-tag"></i> اسم العطر</label>
                            <input type="text" id="productName" required placeholder="أدخل اسم العطر">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="productPrice"><i class="fas fa-money-bill-wave"></i> الثمن (درهم)</label>
                                <input type="number" id="productPrice" min="1" step="0.01" required placeholder="أدخل الثمن">
                            </div>
                            
                            <div class="form-group">
                                <label for="quantity"><i class="fas fa-box"></i> الكمية</label>
                                <input type="number" id="quantity" min="1" required placeholder="أدخل الكمية">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="deliveryPrice"><i class="fas fa-truck"></i> ثمن التوصيل (درهم)</label>
                            <input type="number" id="deliveryPrice" min="0" step="0.01" value="0" placeholder="أدخل ثمن التوصيل">
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-calculator"></i> المجموع</label>
                            <div class="total-display" id="totalDisplay">0.00 درهم</div>
                        </div>
                        
                        <button type="button" class="btn-add" onclick="addSale()">
                            <i class="fas fa-cart-plus"></i> إضافة المنتج
                        </button>
                    </form>
                </div>

                <!-- Sales Receipt -->
                <div class="card receipt-card" id="receiptSection">
                    <h2><i class="fas fa-receipt"></i> بون المبيعات</h2>
                    <div class="receipt" id="receipt">
                        <!-- Receipt will be generated here -->
                    </div>
                    <div class="receipt-actions">
                        <button class="btn-download" onclick="downloadReceipt()">
                            <i class="fas fa-download"></i> تحميل البون (PDF)
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column: Tables and Chart -->
            <div class="col-lg-6">
                <!-- Best Selling Products -->
                <div class="card">
                    <h2><i class="fas fa-trophy"></i> أكثر العطور مبيعاً</h2>
                    <div class="table-container">
                        <table class="products-table" id="bestSellingTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>اسم العطر</th>
                                    <th>الكمية المباعة</th>
                                    <th>الإجمالي (درهم)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Will be filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Monthly Sales Chart -->
                <div class="card">
                    <h2><i class="fas fa-chart-bar"></i> الرسم البياني للمبيعات الشهرية</h2>
                    <div class="chart-container">
                        <canvas id="salesChart"></canvas>
                    </div>
                    <div class="months-list" id="monthsList">
                        <!-- Months will be added by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Monthly Summary Modal -->
    <div class="modal" id="monthlyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-calendar-alt"></i> ملخص الشهر</h3>
                <button class="close-modal" onclick="closeModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="month-summary" id="monthSummary">
                    <!-- Content will be filled by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-download" onclick="downloadMonthlyPDF()">
                    <i class="fas fa-file-pdf"></i> تحميل PDF
                </button>
                <button class="btn-close" onclick="closeModal()">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- Hidden Logo Image -->
    <img id="logoImage" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAJOSURBVHgB7d2xTQMxFMbxMwGiASQaQGmAphkKBigZgA6YAAlqBqAFBgAJCQagAegAJENjJTl5t+DvSVb2/X+SldzJd2eXsyWTt9sfIeMxeT1Vdr2t7fGhuY7N/JI2s5/r9fRs+/ryU5b5B5jfVPqZc29tK9/fR7IBWt+4fvZzMgfXr8/Nddqo5N+W89QHKWn9JhkA3X3bN0TdGNq//wskAqC7b/eGqRvjUAzCAVDat39D6cY4FIPwAFjf/5p1gzjIgLAA2N//tTbgIAOCAmB9/8e1AQsxICgA1vd/cgtYgAFBAbC+/3Mt4I8BRAJgff/nWsASA4gEwPr+L7UBWzCAiAcg1v0/1wYUGOCYAHjf/3NtABkGOCYA3vd/qQ0YMMAxAfC+/0ttwIIBjgmA9/1fagMODHBMALzv/1IbcMAAxwTA+/4vtQEHDHBMALzv/1IbcMAATwRg2/d/HzjVAPcEIPo3/+2Bw0Y8nqO+xaV7fN76DfXf77+S+8IP/2es3/7/01P3L1r6t3/X9tnt7u3nj5/D/S0k/3s+9Rvw/yfy3u+62beFdH/jQ/K/81P/M/rYqOa/8YV4N//kfe/7FzIAAAAASUVORK5CYII=" alt="Logo" style="display: none;">

    <script src="script.js"></script>
</body>
</html>




<style>
    /* Reset & Base Styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Cairo', sans-serif;
    background: #f5f5f5;
    color: #333;
    line-height: 1.6;
    padding-top: 70px;
    padding-bottom: 20px;
}

/* Header */
.header {
    background: #000;
    color: white;
    padding: 15px 30px;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 20px rgba(0,0,0,0.2);
}

.logo h1 {
    margin: 0;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.logo p {
    margin: 5px 0 0 0;
    font-size: 0.9rem;
    opacity: 0.8;
}

.header-right {
    display: flex;
    align-items: center;
    gap: 20px;
}

.notification-icon {
    position: relative;
    cursor: pointer;
    font-size: 1.3rem;
    padding: 10px;
    border-radius: 50%;
    background: rgba(255,255,255,0.1);
    transition: all 0.3s ease;
}

.notification-icon:hover {
    background: rgba(255,255,255,0.2);
    transform: scale(1.1);
}

.badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ff4757;
    color: white;
    border-radius: 50%;
    padding: 2px 6px;
    font-size: 0.7rem;
}

/* Notification Panel */
.notification-panel {
    position: fixed;
    top: 70px;
    left: 20px;
    width: 350px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    z-index: 999;
    display: none;
    animation: slideIn 0.3s ease;
    border: 2px solid #000;
}

@keyframes slideIn {
    from { transform: translateY(-20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.notification-header {
    background: #000;
    color: white;
    padding: 15px;
    border-radius: 10px 10px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.close-btn {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.notification-content {
    padding: 15px;
}

.notification-item {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    border-right: 4px solid #000;
}

.delete-notification {
    background: none;
    border: none;
    color: #ff4757;
    cursor: pointer;
    font-size: 1rem;
    padding: 5px;
}

.countdown {
    font-family: monospace;
    font-size: 1.2rem;
    color: #000;
    margin-top: 5px;
    font-weight: bold;
}

/* Welcome Message */
.welcome-message {
    background: #000;
    color: white;
    padding: 15px;
    margin: 20px;
    border-radius: 10px;
    position: relative;
    animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

.welcome-content {
    position: relative;
}

.close-welcome {
    position: absolute;
    top: 0;
    left: 10px;
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
}

/* Main Layout */
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.row {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
}

@media (min-width: 992px) {
    .row {
        grid-template-columns: 1fr 1fr;
    }
}

/* Cards */
.card {
    background: white;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    margin-bottom: 20px;
    border: 2px solid #000;
}

.card h2 {
    color: #000;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    padding-bottom: 10px;
    border-bottom: 2px solid #000;
}

/* Form Styles */
.form-group {
    margin-bottom: 15px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.form-group label {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 5px;
    color: #333;
    font-weight: 500;
}

.form-group input {
    width: 100%;
    padding: 12px;
    border: 2px solid #000;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
}

.form-group input:focus {
    outline: none;
    border-color: #000;
    box-shadow: 0 0 0 3px rgba(0,0,0,0.1);
}

.total-display {
    background: #000;
    color: white;
    padding: 15px;
    border-radius: 8px;
    font-size: 1.2rem;
    font-weight: bold;
    text-align: center;
}

.btn-add {
    background: #000;
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 8px;
    font-size: 1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    width: 100%;
    transition: all 0.3s ease;
}

.btn-add:hover {
    background: #333;
    transform: scale(1.02);
}

/* Receipt Styles */
.receipt-card {
    display: none;
}

.receipt {
    background: white;
    border: 2px solid #000;
    border-radius: 10px;
    padding: 20px;
    margin: 20px 0;
    font-family: 'Courier New', monospace;
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
}

.receipt-header {
    text-align: center;
    margin-bottom: 20px;
}

.receipt-header .logo-img {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    margin: 0 auto 10px;
    background: #000;
    color: white;
    font-weight: bold;
    font-size: 0.9rem;
    text-align: center;
    padding: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.receipt-line {
    border-bottom: 2px dashed #ccc;
    margin: 15px 0;
    padding-bottom: 15px;
    display: flex;
    justify-content: space-between;
}

.receipt-footer {
    text-align: center;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 2px solid #000;
    color: #666;
    font-style: italic;
    font-weight: bold;
}

.receipt-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.btn-download {
    background: #000;
    color: white;
    border: none;
    padding: 12px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    transition: all 0.3s ease;
}

.btn-download:hover {
    background: #333;
}

/* Table Styles */
.table-container {
    overflow-x: auto;
}

.products-table {
    width: 100%;
    border-collapse: collapse;
}

.products-table th {
    background: #000;
    color: white;
    padding: 12px;
    text-align: right;
    font-weight: 600;
}

.products-table td {
    padding: 12px;
    border-bottom: 1px solid #dee2e6;
}

.products-table tr:hover {
    background: #f8f9fa;
}

/* Chart Styles */
.chart-container {
    position: relative;
    height: 300px;
    margin: 20px 0;
}

.months-list {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 20px;
}

.month-item {
    background: #000;
    color: white;
    padding: 8px 15px;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.month-item:hover {
    background: #333;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1001;
    animation: fadeIn 0.3s ease;
}

.modal-content {
    background: white;
    width: 90%;
    max-width: 500px;
    margin: 50px auto;
    border-radius: 15px;
    overflow: hidden;
    animation: slideUp 0.3s ease;
    border: 2px solid #000;
}

@keyframes slideUp {
    from { transform: translateY(50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.modal-header {
    background: #000;
    color: white;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.close-modal {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    padding: 20px;
    background: #f8f9fa;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    border-top: 1px solid #dee2e6;
}

.btn-close {
    background: #000;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
}

/* Responsive Design */
@media (max-width: 768px) {
    .header {
        padding: 10px 15px;
    }
    
    .logo h1 {
        font-size: 1.2rem;
    }
    
    .notification-panel {
        width: calc(100% - 40px);
        left: 20px;
        right: 20px;
    }
    
    .container {
        padding: 10px;
    }
    
    .card {
        padding: 15px;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .months-list {
        justify-content: center;
    }
}
</style>


<script>
    // البيانات
let salesData = JSON.parse(localStorage.getItem('salesData')) || [];
let monthlySales = JSON.parse(localStorage.getItem('monthlySales')) || {};

// تهيئة الصفحة
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
    updateTotalDisplay();
    renderBestSellingProducts();
    renderMonthlyChart();
    startCountdown();
});

// تهيئة التطبيق
function initializeApp() {
    // إظهار رسالة الترحيب
    if (!localStorage.getItem('welcomeClosed')) {
        document.getElementById('welcomeMessage').style.display = 'block';
    }
    
    // إدارة الإشعارات
    document.getElementById('notificationIcon').addEventListener('click', toggleNotifications);
    document.getElementById('closeNotifications').addEventListener('click', toggleNotifications);
    
    // تحديث المجموع عند تغيير القيم
    document.getElementById('productPrice').addEventListener('input', updateTotalDisplay);
    document.getElementById('quantity').addEventListener('input', updateTotalDisplay);
    document.getElementById('deliveryPrice').addEventListener('input', updateTotalDisplay);
}

// إظهار/إخفاء الإشعارات
function toggleNotifications() {
    const panel = document.getElementById('notificationPanel');
    panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
}

// بدء العد التنازلي
function startCountdown() {
    setInterval(updateCountdown, 1000);
}

// تحديث العد التنازلي
function updateCountdown() {
    const now = new Date();
    const target = new Date(now.getTime() + 2 * 60 * 60 * 1000 + 30 * 60 * 1000 + 45 * 1000);
    
    const diff = target - now;
    
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
    
    document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
    document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
    document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');
}

// حذف الإشعار
function deleteNotification(button) {
    const item = button.closest('.notification-item');
    item.remove();
    
    // تحديث العداد
    const badge = document.querySelector('.badge');
    let count = parseInt(badge.textContent) || 0;
    if (count > 0) {
        badge.textContent = count - 1;
    }
}

// إغلاق رسالة الترحيب
function closeWelcome() {
    document.getElementById('welcomeMessage').style.display = 'none';
    localStorage.setItem('welcomeClosed', 'true');
}

// تحديث عرض المجموع
function updateTotalDisplay() {
    const price = parseFloat(document.getElementById('productPrice').value) || 0;
    const quantity = parseInt(document.getElementById('quantity').value) || 0;
    const deliveryPrice = parseFloat(document.getElementById('deliveryPrice').value) || 0;
    
    const subtotal = price * quantity;
    const total = subtotal + deliveryPrice;
    
    document.getElementById('totalDisplay').textContent = 
        total.toFixed(2) + ' درهم';
}

// إضافة عملية بيع
function addSale() {
    const productName = document.getElementById('productName').value.trim();
    const price = parseFloat(document.getElementById('productPrice').value);
    const quantity = parseInt(document.getElementById('quantity').value);
    const deliveryPrice = parseFloat(document.getElementById('deliveryPrice').value) || 0;
    
    if (!productName || !price || !quantity) {
        alert('يرجى ملء جميع الحقول المطلوبة!');
        return;
    }
    
    const subtotal = price * quantity;
    const total = subtotal + deliveryPrice;
    
    const sale = {
        id: Date.now(),
        productName,
        price,
        quantity,
        deliveryPrice,
        subtotal,
        total,
        date: new Date().toLocaleString('ar-EG')
    };
    
    salesData.push(sale);
    
    // تحديث المبيعات الشهرية (بدون تضمين ثمن التوصيل في المبيعات الأساسية)
    const month = new Date().toLocaleString('ar-EG', { month: 'long', year: 'numeric' });
    if (!monthlySales[month]) {
        monthlySales[month] = {
            total: 0,
            deliveryTotal: 0,
            products: {}
        };
    }
    
    monthlySales[month].total += subtotal; // فقط قيمة المنتجات
    monthlySales[month].deliveryTotal += deliveryPrice; // قيمة التوصيل منفصلة
    
    if (!monthlySales[month].products[productName]) {
        monthlySales[month].products[productName] = 0;
    }
    monthlySales[month].products[productName] += quantity;
    
    // حفظ البيانات
    localStorage.setItem('salesData', JSON.stringify(salesData));
    localStorage.setItem('monthlySales', JSON.stringify(monthlySales));
    
    // تحديث العرض
    updateTotalDisplay();
    renderBestSellingProducts();
    renderMonthlyChart();
    generateReceipt(sale);
    
    // إعادة تعيين النموذج
    document.getElementById('saleForm').reset();
    document.getElementById('deliveryPrice').value = '0';
    document.getElementById('totalDisplay').textContent = '0.00 درهم';
    
    // إظهار البون
    document.getElementById('receiptSection').style.display = 'block';
}

// توليد البون
function generateReceipt(sale) {
    const receipt = document.getElementById('receipt');
    
    receipt.innerHTML = `
        <div class="receipt-header">
            <div class="logo-img">ELHOMSSI<br>PARFUMS</div>
            <h3>فاتورة مبيعات</h3>
            <p>${sale.date}</p>
            <p style="color: #666; font-size: 0.9em; margin-top: 5px;">رقم الفاتورة: #${sale.id.toString().slice(-6)}</p>
        </div>
        
        <div class="receipt-line">
            <span>اسم العطر:</span>
            <span><strong>${sale.productName}</strong></span>
        </div>
        
        <div class="receipt-line">
            <span>ثمن الوحدة:</span>
            <span>${sale.price.toFixed(2)} درهم</span>
        </div>
        
        <div class="receipt-line">
            <span>الكمية:</span>
            <span>${sale.quantity}</span>
        </div>
        
        <div class="receipt-line">
            <span>المجموع الفرعي:</span>
            <span>${sale.subtotal.toFixed(2)} درهم</span>
        </div>
        
        <div class="receipt-line">
            <span>ثمن التوصيل:</span>
            <span>${sale.deliveryPrice.toFixed(2)} درهم</span>
        </div>
        
        <div class="receipt-line" style="border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 15px;">
            <span><strong>المجموع النهائي:</strong></span>
            <span><strong style="font-size: 1.2em; color: #000;">${sale.total.toFixed(2)} درهم</strong></span>
        </div>
        
        <div class="receipt-footer">
            <p style="color: #000; font-weight: bold; margin-bottom: 5px;">شكراً لثقتكم بنا</p>
            <p>التوصيل أقل من 24 ساعة، ستحصل على طلبك قريباً</p>
        </div>
    `;
}

// تحميل البون كـ PDF
function downloadReceipt() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const receipt = document.getElementById('receipt');
    const lines = receipt.querySelectorAll('.receipt-line');
    
    // إعداد النص العربي
    doc.setFont('courier');
    
    // العنوان
    doc.setFontSize(20);
    doc.text('ELHOMSSI PARFUMS', 105, 20, { align: 'center' });
    
    doc.setFontSize(14);
    doc.text('فاتورة مبيعات', 105, 30, { align: 'center' });
    
    // التاريخ
    doc.setFontSize(12);
    const date = new Date().toLocaleString('ar-EG');
    doc.text(date, 105, 37, { align: 'center' });
    
    // تفاصيل الفاتورة
    let y = 50;
    doc.setFontSize(11);
    
    lines.forEach(line => {
        const spans = line.querySelectorAll('span');
        if (spans.length >= 2) {
            const leftText = spans[0].textContent;
            const rightText = spans[1].textContent;
            
            doc.text(leftText, 20, y);
            doc.text(rightText, 190, y, { align: 'right' });
            y += 10;
        }
    });
    
    // تذييل الفاتورة
    doc.setFontSize(12);
    doc.text('شكراً لثقتكم بنا', 105, y + 10, { align: 'center' });
    doc.text('التوصيل أقل من 24 ساعة، ستحصل على طلبك قريباً', 105, y + 20, { align: 'center' });
    
    // حفظ الملف
    doc.save(`فاتورة-ELHOMSSI-${Date.now()}.pdf`);
}

// عرض أكثر المنتجات مبيعاً
function renderBestSellingProducts() {
    const products = {};
    
    salesData.forEach(sale => {
        if (!products[sale.productName]) {
            products[sale.productName] = {
                quantity: 0,
                total: 0
            };
        }
        products[sale.productName].quantity += sale.quantity;
        products[sale.productName].total += sale.subtotal; // بدون التوصيل
    });
    
    const sortedProducts = Object.entries(products)
        .sort((a, b) => b[1].quantity - a[1].quantity)
        .slice(0, 10);
    
    const tbody = document.querySelector('#bestSellingTable tbody');
    tbody.innerHTML = '';
    
    if (sortedProducts.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="4" style="text-align: center; color: #666;">لا توجد مبيعات حتى الآن</td>
        `;
        tbody.appendChild(row);
    } else {
        sortedProducts.forEach(([name, data], index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${name}</td>
                <td>${data.quantity}</td>
                <td>${data.total.toFixed(2)} درهم</td>
            `;
            tbody.appendChild(row);
        });
    }
}

// عرض الرسم البياني الشهري
function renderMonthlyChart() {
    const ctx = document.getElementById('salesChart').getContext('2d');
    const months = Object.keys(monthlySales).reverse().slice(0, 6);
    const totals = months.map(month => monthlySales[month].total);
    
    if (window.salesChartInstance) {
        window.salesChartInstance.destroy();
    }
    
    window.salesChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: months,
            datasets: [{
                label: 'المبيعات الشهرية (بدون التوصيل)',
                data: totals,
                backgroundColor: 'rgba(0, 0, 0, 0.7)',
                borderColor: 'rgba(0, 0, 0, 1)',
                borderWidth: 2,
                borderRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            onClick: function(evt, elements) {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    showMonthlySummary(months[index]);
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString('ar-EG') + ' درهم';
                        }
                    }
                },
                x: {
                    ticks: {
                        autoSkip: false,
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        font: {
                            family: 'Cairo',
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.parsed.y.toLocaleString('ar-EG') + ' درهم';
                        }
                    }
                }
            }
        }
    });
    
    // عرض قائمة الأشهر
    const monthsList = document.getElementById('monthsList');
    if (months.length === 0) {
        monthsList.innerHTML = '<p style="text-align: center; color: #666;">لا توجد بيانات شهرية</p>';
    } else {
        monthsList.innerHTML = months.map(month => 
            `<div class="month-item" onclick="showMonthlySummary('${month}')">${month}</div>`
        ).join('');
    }
}

// عرض ملخص الشهر
function showMonthlySummary(month) {
    const data = monthlySales[month];
    if (!data) return;
    
    // الحصول على أكثر المنتجات مبيعاً
    const products = Object.entries(data.products)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
    
    const totalWithDelivery = data.total + data.deliveryTotal;
    const totalProducts = Object.values(data.products).reduce((a, b) => a + b, 0);
    
    document.getElementById('monthSummary').innerHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
            <h4 style="color: #000; margin-bottom: 10px;">
                <i class="fas fa-calendar"></i> ${month}
            </h4>
        </div>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h5 style="margin-bottom: 10px;"><i class="fas fa-money-bill-wave"></i> إجمالي مبيعات المنتجات</h5>
            <p style="font-size: 1.5em; color: #000; font-weight: bold; text-align: center;">
                ${data.total.toFixed(2)} درهم
            </p>
        </div>
        
        <div style="background: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h5 style="margin-bottom: 10px;"><i class="fas fa-truck"></i> إجمالي ثمن التوصيل</h5>
            <p style="font-size: 1.2em; color: #333; font-weight: bold; text-align: center;">
                ${data.deliveryTotal.toFixed(2)} درهم
            </p>
        </div>
        
        <div style="background: #000; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h5 style="margin-bottom: 10px;"><i class="fas fa-calculator"></i> الإجمالي الكامل (مع التوصيل)</h5>
            <p style="font-size: 1.8em; color: white; font-weight: bold; text-align: center;">
                ${totalWithDelivery.toFixed(2)} درهم
            </p>
        </div>
        
        <div style="margin-bottom: 20px;">
            <h5><i class="fas fa-trophy"></i> أكثر المنتجات مبيعاً</h5>
            ${products.length > 0 ? `
                <ul style="list-style: none; padding: 0;">
                    ${products.map(([product, quantity], index) => `
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between;">
                            <div>
                                <span style="background: #000; color: white; padding: 2px 8px; border-radius: 4px; margin-left: 10px;">${index + 1}</span>
                                <span style="font-weight: 500;">${product}</span>
                            </div>
                            <span style="color: #000; font-weight: bold;">${quantity} قطعة</span>
                        </li>
                    `).join('')}
                </ul>
            ` : '<p style="text-align: center; color: #666;">لا توجد مبيعات</p>'}
        </div>
        
        <div style="color: #666; font-size: 0.9em; padding: 10px; border-top: 1px solid #dee2e6;">
            <p><i class="fas fa-info-circle"></i> عدد المنتجات المباعة: ${totalProducts}</p>
            <p><i class="fas fa-chart-line"></i> متوسط المبيعات اليومية: ${(data.total / 30).toFixed(2)} درهم</p>
            <p><i class="fas fa-box"></i> عدد المنتجات المختلفة: ${Object.keys(data.products).length}</p>
        </div>
    `;
    
    document.getElementById('monthlyModal').style.display = 'block';
}

// إغلاق النافذة المنبثقة
function closeModal() {
    document.getElementById('monthlyModal').style.display = 'none';
}

// تحميل البون كـ PDF (مُحسّن)
function downloadReceipt() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // إعدادات للغة العربية
    doc.setR2L(true); // تمكين الكتابة من اليمين لليسار
    
    // إضافة خط يدعم العربية (نستخدم الخط الافتراضي مع تعديلات)
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(12);
    
    const receipt = document.getElementById('receipt');
    const lines = receipt.querySelectorAll('.receipt-line');
    
    // الحصول على البيانات
    const header = receipt.querySelector('.receipt-header');
    const date = header ? header.querySelector('p')?.textContent : new Date().toLocaleString('ar-EG');
    const invoiceNum = header ? header.querySelector('p[style*="font-size: 0.9em"]')?.textContent : '';
    
    // العنوان الرئيسي
    doc.setFontSize(20);
    doc.setFont('helvetica', 'bold');
    doc.text('ELHOMSSI PARFUMS', 105, 20, { align: 'center' });
    
    // عنوان الفاتورة
    doc.setFontSize(16);
    doc.text('فاتورة مبيعات', 105, 30, { align: 'center' });
    
    // معلومات الفاتورة
    doc.setFontSize(11);
    doc.setFont('helvetica', 'normal');
    doc.text(date, 105, 38, { align: 'center' });
    
    if (invoiceNum) {
        doc.text(invoiceNum, 105, 44, { align: 'center' });
    }
    
    // خط فاصل
    doc.setDrawColor(0, 0, 0);
    doc.setLineWidth(0.5);
    doc.line(20, 48, 190, 48);
    
    // تفاصيل الفاتورة
    let y = 55;
    doc.setFontSize(12);
    
    lines.forEach(line => {
        const spans = line.querySelectorAll('span');
        if (spans.length >= 2) {
            const leftText = spans[0].textContent;
            const rightText = spans[1].textContent;
            
            // كتابة النص مع محاذاة مناسبة للعربية
            doc.text(rightText, 190, y, { align: 'right' });
            doc.text(leftText, 20, y, { align: 'left' });
            
            y += 10;
            
            // إضافة خط فاصل للمجموع النهائي
            if (leftText.includes('المجموع النهائي')) {
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(1);
                doc.line(20, y - 2, 190, y - 2);
                y += 5;
            }
        }
    });
    
    // تذييل الفاتورة
    y += 10;
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text('شكراً لثقتكم بنا', 105, y, { align: 'center' });
    
    y += 8;
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text('التوصيل أقل من 24 ساعة، ستحصل على طلبك قريباً', 105, y, { align: 'center' });
    
    // معلومات إضافية
    y += 15;
    doc.setFontSize(9);
    doc.setTextColor(100, 100, 100);
    doc.text('للاستفسارات: contact@elhomssi.com | هاتف: +212 123 456 789', 105, y, { align: 'center' });
    
    // حفظ الملف
    doc.save(`فاتورة-ELHOMSSI-${Date.now()}.pdf`);
}

// تحميل ملخص الشهر كـ PDF (مُحسّن)
function downloadMonthlyPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // إعدادات للغة العربية
    doc.setR2L(true);
    doc.setFont('helvetica', 'normal');
    
    const monthElement = document.querySelector('#monthSummary h4');
    const month = monthElement ? monthElement.textContent.replace(' ', '') : 'غير محدد';
    
    // العنوان الرئيسي
    doc.setFontSize(22);
    doc.setFont('helvetica', 'bold');
    doc.text('ELHOMSSI PARFUMS', 105, 20, { align: 'center' });
    
    // عنوان التقرير
    doc.setFontSize(18);
    doc.text(`تقرير مبيعات ${month}`, 105, 32, { align: 'center' });
    
    // تاريخ الإنشاء
    doc.setFontSize(11);
    doc.setFont('helvetica', 'normal');
    const creationDate = new Date().toLocaleString('ar-EG', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    doc.text(`تاريخ الإنشاء: ${creationDate}`, 105, 40, { align: 'center' });
    
    // خط فاصل
    doc.setDrawColor(0, 0, 0);
    doc.setLineWidth(0.5);
    doc.line(20, 45, 190, 45);
    
    let y = 55;
    
    // الحصول على محتوى الملخص
    const summaryContent = document.getElementById('monthSummary');
    const sections = summaryContent.querySelectorAll('div[style*="background"]');
    
    // عرض كل قسم
    sections.forEach((section, index) => {
        if (y > 250) {
            doc.addPage();
            y = 20;
        }
        
        const title = section.querySelector('h5')?.textContent || '';
        const value = section.querySelector('p')?.textContent || '';
        
        if (title && value) {
            // خلفية للقسم (محاكاة للون في HTML)
            if (index === 2) { // القسم الأسود
                doc.setFillColor(0, 0, 0);
                doc.rect(20, y - 8, 170, 25, 'F');
                doc.setTextColor(255, 255, 255);
            } else {
                doc.setFillColor(240, 240, 240);
                doc.rect(20, y - 8, 170, 25, 'F');
                doc.setTextColor(0, 0, 0);
            }
            
            // العنوان
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(title, 185, y, { align: 'right' });
            
            // القيمة
            doc.setFontSize(index === 2 ? 16 : 14);
            doc.text(value, 105, y + 10, { align: 'center' });
            
            y += 30;
            doc.setTextColor(0, 0, 0);
        }
    });
    
    // عرض قائمة المنتجات الأكثر مبيعاً
    y += 10;
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text('المنتجات الأكثر مبيعاً', 185, y, { align: 'right' });
    
    y += 10;
    const productsList = summaryContent.querySelector('ul');
    if (productsList) {
        const products = productsList.querySelectorAll('li');
        doc.setFontSize(11);
        doc.setFont('helvetica', 'normal');
        
        products.forEach((product, index) => {
            if (y > 270) {
                doc.addPage();
                y = 30;
            }
            
            const text = product.textContent.trim();
            doc.text(text, 185, y, { align: 'right' });
            y += 8;
            
            // خط فاصل بين المنتجات
            if (index < products.length - 1) {
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.2);
                doc.line(30, y - 2, 185, y - 2);
                y += 3;
            }
        });
    }
    
    // المعلومات الإحصائية
    const stats = summaryContent.querySelector('div[style*="color: #666"]');
    if (stats) {
        y += 10;
        doc.setDrawColor(0, 0, 0);
        doc.setLineWidth(0.5);
        doc.line(20, y, 190, y);
        y += 5;
        
        const statsText = stats.textContent.split('\n').filter(line => line.trim());
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(100, 100, 100);
        
        statsText.forEach(line => {
            if (y > 280) {
                doc.addPage();
                y = 20;
            }
            
            doc.text(line.trim(), 185, y, { align: 'right' });
            y += 7;
        });
    }
    
    // تذييل الصفحة
    doc.setFontSize(9);
    doc.setTextColor(150, 150, 150);
    doc.text('تم إنشاء هذا التقرير تلقائياً بواسطة نظام إدارة مبيعات ELHOMSSI Parfums', 105, 290, { align: 'center' });
    doc.text('جميع الحقوق محفوظة © ' + new Date().getFullYear(), 105, 295, { align: 'center' });
    
    // حفظ الملف
    doc.save(`تقرير-مبيعات-${month}-${Date.now()}.pdf`);
    }
</script>
